name: CI

on:
  push:
    branches: [main]
  pull_request:

jobs:
  # ─── Stage 1: Lint (no Docker, ~30s) ─────────────
  lint-backend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - run: pip install "ruff>=0.8"
      - run: ruff check backend/app/

  lint-frontend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - run: npm ci
        working-directory: frontend
      - run: npx tsc --noEmit
        working-directory: frontend

  # ─── Stage 2: Build Docker images (~2min) ─────────
  build:
    runs-on: ubuntu-latest
    needs: [lint-backend, lint-frontend]
    strategy:
      matrix:
        include:
          - image: trip-backend
            context: ./backend
          - image: trip-frontend
            context: ./frontend
          - image: trip-agents
            context: ./agents
    steps:
      - uses: actions/checkout@v4
      - run: docker build -t ${{ matrix.image }} ${{ matrix.context }}

  # ─── Stage 3: E2E tests via Docker Compose (~3-5min) ──
  test:
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - uses: actions/checkout@v4

      - name: Create .env from example
        run: cp .env.example .env

      - name: Start infra and create pgvector extension
        run: |
          docker compose -f docker-compose.ci.yml up -d --build --wait trip-postgres trip-redis
          docker compose -f docker-compose.ci.yml exec -T trip-postgres psql -U tripuser -d tripdb -c 'CREATE EXTENSION IF NOT EXISTS vector; CREATE EXTENSION IF NOT EXISTS "uuid-ossp";'

      - name: Start backend and wait for healthy
        run: |
          docker compose -f docker-compose.ci.yml up -d --build trip-backend
          echo "Waiting for backend..."
          for i in $(seq 1 30); do
            if docker compose -f docker-compose.ci.yml exec -T trip-backend python -c "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"; then
              echo " Backend is ready"
              exit 0
            fi
            echo "  attempt $i/30..."
            sleep 2
          done
          echo "Backend failed to start"
          docker compose -f docker-compose.ci.yml logs trip-backend
          exit 1

      - name: Run migrations and seed data
        run: |
          docker compose -f docker-compose.ci.yml exec -T -e PYTHONPATH=/app -w /app trip-backend alembic upgrade head
          docker compose -f docker-compose.ci.yml exec -T -e PYTHONPATH=/app -w /app trip-backend python -m scripts.seed_packages

      - name: Run backend tests
        run: docker compose -f docker-compose.ci.yml exec -T -e PYTHONPATH=/app -w /app trip-backend pytest app/tests/ -v

      - name: Tear down
        if: always()
        run: docker compose -f docker-compose.ci.yml down -v
