stages:
  - lint
  - build
  - test

# ─── Stage 1: Lint (no Docker, ~30s) ─────────────

lint:backend:
  stage: lint
  image: python:3.12-slim
  script:
    - pip install "ruff>=0.8"
    - ruff check backend/app/

lint:frontend:
  stage: lint
  image: node:20-alpine
  before_script:
    - corepack enable
    - corepack prepare pnpm@latest --activate
    - cd frontend && pnpm install --frozen-lockfile
  script:
    - pnpm exec tsc --noEmit

# ─── Stage 2: Build Docker images (~2min) ─────────

.docker-base:
  image: docker:27
  services:
    - docker:27-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - docker compose version

build:backend:
  stage: build
  extends: .docker-base
  script:
    - docker build -t trip-backend ./backend

build:frontend:
  stage: build
  extends: .docker-base
  script:
    - docker build -t trip-frontend ./frontend

build:agents:
  stage: build
  extends: .docker-base
  script:
    - docker build -t trip-agents ./agents

# ─── Stage 3: E2E tests via Docker Compose (~3-5min) ──

test:backend:
  stage: test
  extends: .docker-base
  script:
    - cp .env.example .env
    - docker compose -f docker-compose.ci.yml up -d --build --wait trip-postgres trip-redis
    - docker compose -f docker-compose.ci.yml exec -T trip-postgres psql -U tripuser -d tripdb -c 'CREATE EXTENSION IF NOT EXISTS vector; CREATE EXTENSION IF NOT EXISTS "uuid-ossp";'
    - docker compose -f docker-compose.ci.yml up -d --build trip-backend
    - |
      echo "Waiting for backend..."
      for i in $(seq 1 30); do
        if docker compose -f docker-compose.ci.yml exec -T trip-backend python -c "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"; then
          echo " Backend is ready"
          break
        fi
        echo "  attempt $i/30..."
        sleep 2
      done
    - docker compose -f docker-compose.ci.yml exec -T -e PYTHONPATH=/app -w /app trip-backend alembic upgrade head
    - docker compose -f docker-compose.ci.yml exec -T -e PYTHONPATH=/app -w /app trip-backend python -m scripts.seed_packages
    - docker compose -f docker-compose.ci.yml exec -T -e PYTHONPATH=/app -w /app trip-backend pytest app/tests/ -v
    - docker compose -f docker-compose.ci.yml down -v
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
